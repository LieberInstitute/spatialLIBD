---
title: "Guide to Multi-Gene Plots"
author: 
  - name: Nicholas J. Eagles
    affiliation:
    - Lieber Institute for Brain Development
    email: nickeagles77@gmail.com
output: 
  BiocStyle::html_document:
    self_contained: yes
    toc: true
    toc_float: true
    toc_depth: 2
    code_folding: show
date: "`r doc_date()`"
package: "`r pkg_ver('spatialLIBD')`"
vignette: >
  %\VignetteIndexEntry{Guide to Multi-Gene Plots}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}  
---

```{r, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>"
)
```

```{r vignetteSetup, echo=FALSE, message=FALSE, warning = FALSE}
## For links
library("BiocStyle")

## Track time spent on making the vignette
startTime <- Sys.time()

## Bib setup
library("RefManageR")

## Write bibliography information
bib <- c(
    R = citation(),
    knitr = citation("knitr")[3],
    RColorBrewer = citation("RColorBrewer")[1],
    RefManageR = citation("RefManageR")[1],
    rmarkdown = citation("rmarkdown")[1],
    sessioninfo = citation("sessioninfo")[1],
    SpatialExperiment = citation("SpatialExperiment")[1],
    spatialLIBD = citation("spatialLIBD")[1]
)
```

# Plotting One Gene

A typical use of [`vis_gene`](http://research.libd.org/spatialLIBD/reference/vis_gene.html) involves
plotting the spatial distribution of a single gene or continuous variable of interest.

```{r "setup", message = FALSE, warning = FALSE}
library("spatialLIBD")
spe <- fetch_data(type = "spatialDLPFC_Visium_example_subset")

white_matter_genes <- c("GFAP", "AQP4", "MBP", "PLP1")
white_matter_genes <- rowData(spe)$gene_search[
    rowData(spe)$gene_name %in% white_matter_genes
]
```

```{r "single_gene"}
vis_gene(spe, geneid = white_matter_genes[1])
```

# Plotting Multiple Genes

However, the `geneid` parameter to `vis_gene` may also take a vector of genes or continuous
variables in `colData(spe)`. In this way, the expression of multiple genes can be summarized
into a single value for each spot, displayed just as a single gene for `geneid` would be.
`spatialLIBD` provides three methods for merging the information from multiple continuous
variables, which may be specified through the `multi_gene_method` parameter to `vis_gene`.

## Averaging Z-scores

The default is `multi_gene_method = "z_score"`. Essentially, the expression for each gene is
normalized to be a Z-score. If a particular spot has a value of `1` for a particular gene,
this would indicate that spot has expression one standard deviation above the mean expression
across all spots for that gene. Next, for each spot, Z-scores are averaged across genes.
Compared to simply averaging raw gene expression across genes, the `"z_score"` method
is insensitive to absolute expression levels (highly expressed genes don't dominate plots),
and instead focuses on how each gene varies spatially, weighting each gene equally.

Let's plot all four white matter genes using this method.

```{r "multi_gene_z"}
vis_gene(spe, geneid = white_matter_genes, multi_gene_method = "z_score")
```

## Summarizing with PCA

Another option is `multi_gene_method = "pca"`. A matrix is formed, where genes or continuous
features are columns, and spots are rows. PCA is performed, and the first principal component
is plotted spatially. The idea is that the first PC captures the dominant spatial signature
of the feature set. Next, its direction is reversed if the majority of coefficients (from the
"rotation matrix") across features are negative. When the features are genes whose expression
is highly correlated (like our white-matter-gene example!), this optional reversal encourages
higher values in the plot to represent areas of higher expression of the features. For our case,
this leads to the intuitive result that "expression" is higher in white matter for white-matter
genes, which is not otherwise guaranteed (the "sign" of PCs is arbitary)!

```{r "multi_gene_pca"}
vis_gene(spe, geneid = white_matter_genes, multi_gene_method = "pca")
```

## Plotting Sparsity of Expression

This final option is `multi_gene_method = "sparsity"`. For each spot, the proportion of features
with positive expression is plotted. This method is typically only meaningful when features
are raw gene counts that are expected to be quite sparse (have zero counts) at certain regions
of the tissue and not others. It also performs better with a larger number of genes; with our
example of four white-matter genes, the proportion may only hold values of 0, 0.25, 0.5, 0.75,
and 1, which is not visually informative.

The white-matter example is thus poor due to lack of sparsity and low number of genes:

```{r "multi_gene_sparsity"}
vis_gene(spe, geneid = white_matter_genes, multi_gene_method = "sparsity")
```

Code for creating the vignette

```{r createVignette, eval=FALSE}
## Create the vignette
library("rmarkdown")
system.time(render("multi_gene_plots.Rmd"))

## Extract the R code
library("knitr")
knit("multi_gene_plots.Rmd", tangle = TRUE)
```


Date the vignette was generated.

```{r reproduce1, echo=FALSE}
## Date the vignette was generated
Sys.time()
```

Wallclock time spent generating the vignette.

```{r reproduce2, echo=FALSE}
## Processing time in seconds
totalTime <- diff(c(startTime, Sys.time()))
round(totalTime, digits = 3)
```

`R` session information.

```{r reproduce3, echo=FALSE}
## Session info
library("sessioninfo")
options(width = 120)
session_info()
```

# Bibliography

This vignette was generated using `r Biocpkg('BiocStyle')` `r Citep(bib[['BiocStyle']])`, `r CRANpkg('knitr')` `r Citep(bib[['knitr']])` and `r CRANpkg('rmarkdown')` `r Citep(bib[['rmarkdown']])` running behind the scenes.

Citations made with `r CRANpkg('RefManageR')` `r Citep(bib[['RefManageR']])`.

```{r vignetteBiblio, results = 'asis', echo = FALSE, warning = FALSE, message = FALSE}
## Print bibliography
PrintBibliography(bib, .opts = list(hyperlink = "to.doc", style = "html"))
```
